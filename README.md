# Практика по ООП
## About
*Что это?*

Telegram бот, написанный на Java в рамках курса по ООП.

*Что умеет этот бот?*

С помощью этого бота ты сможешь найти цены на интересующие тебя книги по их ISBN-коду во всех книжных магазинах России.

Переходи по ссылке и пользуйся ботом [OptimumPrice](https://t.me/optimumprice_bot)!


## Ход разработки/список задач
*Ниже последовательно описан процесс разработки Telegram бота на Java, разбитый на 6 этапов.*
### Задача №1
*Постановка:*
Создать примитивную структуру будущего бота с классами, которые будут считывать и обрабатывать запросы.

*Что сделано?*
1. Создано 5 классов:
	- Handler: обрабатывает команды с консоли 
	- Dispatcher: считывает/выводит c/на консоли(-ь) результат обработки команды 
	- Poem: присылает рандомный стих 
	- Main
	- BotRequest для считывания разных типов данных
2. Handler покрыт JUnit тестами (тестируются 4 метода)
3. Добавлен pom.xml с зависимостями
### Задача №2
*Постановка:*
Перенести имеющуюся логику в Telegram с помощью TelegramBotApi.

*Что сделано?*
1. Для удобства в работе с разными типами данных был создан интерфейс UpdateHandler и классы:
	- PhotoUpdate - обработка фото
	- TextUpdate - обработка текстовых сообщений
	- MessageUpdate - универсальный обработчик (не используется)
2. По аналогии с BotRequest был создан класс BotResponse
3. Все функции бота, реализованные в первой задаче, были перенесены в Telegram
### Задача №3
*Постановка:*
При получении фото бот должен скачать его и проверить на наличие штрихкода (ISBN книги). При обнаружении штрихкода информацию с него нужно перевести в текстовый формат. Далее на сайт knigabook.com нужно отправить запрос с ISBN с целью получения информации по книге (название, автор, кол-во страниц и т.п.)

*Что сделано?*
1. Создано 3 класса:
	- FileDownloader: обращается к API Telegram и по file_id присланного пользователем файла скачивает его в папку resources
	- BarcodeReader: проверяет полученное от пользователя фото на наличие штрихкода с помощью библиотеки ZXing. И с помощью этой же библиотеки информация из штрихкода конвертируется в текст
	- KnigaBookParser: использует извлечённый из штрихкода ISBN код для обращения к сайту knigabook.com с целью получения информации по книге (название, автор, кол-во страниц, издательство и т.п.). Кроме этого скачивается обложка книги (при наличии) 
2. В классе Handler создан метод getBookInf(), который объединяет работу всех 3 вышеперечисленных классов и формирует финальный BotResponse
### Задача №4
*Постановка:*
Добавить функцию, которая при получении штрихкода кроме информации о книге будет присылать список цен на это издание из разных интернет-магазинов (информацию о ценах можно брать с Findbook.ru)

Добавить InlineMarkupKeyboard для того, чтобы можно было изменять содержимое сообщения, присланного ботом, или прикреплять какие-нибудь ссылки 

*Что сделано?*

1. Для работы с InlineMarkup клавиатурой были обновлены классы BotResponse и BotRequest, в handlers был добавлен класс CallbackQueryUpdate. Теперь бот обрабатывает нажатия кнопок пользователем, может изменять содержимое текстовых сообщений и фотографий 
2. Добавлен класс FindBookParser для получения информации о цене книги с сайта FindBook
3. Вместо скачивания фотографий классы FileDownloader, KnigaBookParser теперь работают с объектами BufferedImage

### Задача №5
*Постановка:*
Если штрихкод на книге повреждён и бот не может его обработать (или этого штрихкода вообще нет), то пользователь сможет вручную ввести код ISBN и получить желаемую информацию
Кроме того, если пользователь отправляет не просто фото (compressed image), а файл с изображением, то необходимо уметь обрабатывать файлы, т.е. создать обработчик DocumentHandler

*Что сделано?*

1. Создан класс DocumentHandler для обработки отправленных пользователем файлов
2. В случае, если пользователю не удаётся отправить фото со штрихкодом или ISBN на обложке не соответствует тексту штрихкода, то значение ISBN можно отправить в виде текстового сообщения
3. В Handler'е был создан метод validateISBN для проверки корректности переданного пользователем ISBN в виде фото или текста. Метод обложен тестами в классе HandlerTest
4. Создан enum-класс Response, содержащий тексты ответов, которые отправляет бот при вызвове команд или возникновении проблем, связанных с обработкой ISBN

### Задача №6
*Постановка:*
Добавить логирование ошибок и информации о действиях пользователя с помощью SLF4J 
Обновить класс BarcodeReader (научиться считывать изображения EAN13 с разных ракурсов)
Задеплоить бота на Heroku

*Что сделано?*

1. Добавлено логирование ошибок и информации о действиях пользователя
2. В BarcodeReader'е был создан метод rotateBitmap, с помощью которого теперь возможно считывать перевёрнутые штрихкоды (формата EAN13)
3. Обновление и реструктуризация проекта для запуска на Heroku
4. Бот запущен на Heroku

## Запуск бота на Heroku
Чтобы запустить бота на Heroku, следуйте данной инструкции:
1. Склонируйте репозиторий:
	````
	$ git clone https://github.com/arhansolo/oop
	$ cd oop
	````
2. Компиляция и упаковка вашего проекта:
	````
	$ mvn clean install
	````
 
3. Войдите в свой аккаунт Heroku и создайте приложение:
	````
	$ heroku login
	$ heroku create <имя приложения>
	````
	или если уже есть созданное приложение, то после авторизации просто переключитесь на нужное приложение:
	````
	$ heroku git:remote -a <имя приложения>
	````
4. Пушим приложение в репозиторий Heroku:
	````
	$ git push heroku master
	````
5. Добавьте токен и название бота в переменные окружения:
	````
	$ heroku config:set TOKEN=<токен бота>
	$ heroku config:set USERNAME=<имя бота>
	````
	для проверки корректности введённых данных используйте команду:
	````
	$ heroku config
	````
6. Устанавливаем количество контейнеров (dynos) для типа процесса worker (или любого другого, указанного в Procfile):
	````
	$ heroku ps:scale worker=1
	````
7. Проверить корректность работы приложения можно, посмотрев логи:
	````
	$ heroku logs
	````
8. Тестируйте приложение в Telegram

Все вышеописанные действия также можно выполнить на сайте Heroku в разделе вашего приложения (вкладка Deploy)